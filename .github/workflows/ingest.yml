name: Ingest OpenAPI -> Postman

on:
  push:
    paths:
      - 'specs/**'
      - 'scripts/**'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  ingest:
    runs-on: ubuntu-latest
    env:
      POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
      POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
      POSTMAN_COLLECTION_UID: ${{ secrets.POSTMAN_COLLECTION_UID }}
      POSTMAN_ALLOW_BOOTSTRAP_CREATE: true
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_SPEC_S3_URI: ${{ secrets.AWS_SPEC_S3_URI }}
      DEV_BASE_URL: ${{ secrets.DEV_BASE_URL }}
      QA_BASE_URL: ${{ secrets.QA_BASE_URL }}
      UAT_BASE_URL: ${{ secrets.UAT_BASE_URL }}
      PROD_BASE_URL: ${{ secrets.PROD_BASE_URL }}
      JWT_ISSUER: ${{ secrets.JWT_ISSUER }}
      JWT_AUDIENCE: ${{ secrets.JWT_AUDIENCE }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      POSTMAN_USE_PATCH: "true"
      SYNC_LINKED_COLLECTIONS: "true"
      POSTMAN_LINKED_COLLECTION_UIDS: ${{ secrets.POSTMAN_LINKED_COLLECTION_UIDS }}
      USE_SPEC_HUB: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify AWS CLI
        shell: bash
        run: |
          set -euo pipefail
          echo "Verifying AWS CLI is available"
          aws --version

      - name: Pre-flight checks and diagnostics
        shell: bash
        run: |
          set -euo pipefail
          echo "Workspace: $(pwd)"
          echo "Files:"
          ls -la || true
          echo "Scripts:"
          ls -la scripts/ || true
          # Ensure generated dirs exist
          mkdir -p generated generated/environments
          # Validate required env vars are present (do not print secret values)
          missing=false
          for v in POSTMAN_API_KEY POSTMAN_WORKSPACE_ID DEV_BASE_URL QA_BASE_URL UAT_BASE_URL PROD_BASE_URL JWT_ISSUER JWT_AUDIENCE JWT_SECRET; do
            if [ -z "${!v:-}" ]; then
              echo "Missing env var: $v"
              missing=true
            fi
          done
          if [ "$missing" = true ]; then
            echo "One or more required env vars are missing; aborting."
            exit 1
          fi
          if [ -n "${POSTMAN_COLLECTION_UID:-}" ]; then
            echo "POSTMAN_COLLECTION_UID is set (will target existing collection)"
          else
            echo "POSTMAN_COLLECTION_UID is not set (first run will create a new collection)"
          fi

      - name: Diagnose Postman access
        shell: bash
        run: |
          set -euo pipefail
          echo "Running Postman access diagnostics"
          python scripts/diagnose_postman_access.py

      - name: Run ingestion
        shell: bash
        run: |
          set -euo pipefail
          pwd
          ls -la
          ls -la scripts/
          mkdir -p generated generated/environments
          # If AWS_SPEC_S3_URI is provided, fetch the spec from S3 first
          if [ -n "${AWS_SPEC_S3_URI:-}" ]; then
            echo "Fetching OpenAPI spec from S3..."
            python scripts/fetch_spec_aws.py
          fi
          python scripts/ingest_refund_api.py

      - name: Show last log lines
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          echo '--- postman actions log (tail) ---'
          test -f generated/postman_actions.log && tail -n 40 generated/postman_actions.log || echo "No postman_actions.log yet"

      # Upload generated state so other workflows (reset) can find the last-used UIDs
      # Runner filesystems are ephemeral; we persist these artifacts to enable safe resets.
      - name: Upload postman state artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: postman_state
          path: |
            generated/postman_ids.json
            generated/state.json
          if-no-files-found: warn
