name: 04 - Reset Demo (Safe reset)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type RESET to confirm demo reset'
        required: true

permissions:
  contents: read
  actions: read

jobs:
  reset:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate confirmation
        run: |
          if [[ "${{ github.event.inputs.confirm }}" != "RESET" ]]; then echo "Confirmation did not match 'RESET' - aborting" && exit 1; fi

      # Find & download the latest postman_state artifact produced by the ingest job
      # We query the GitHub Actions API for the most recent successful `ingest.yml` run
      # on `main` and then download that run's artifact. Runner filesystems are
      # ephemeral so artifacts are used to persist state between workflow runs.
      - name: Find latest ingest run id
        id: find_ingest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python - << 'PY'
          import os, sys, json, urllib.request
          repo = os.environ['GITHUB_REPOSITORY']
          token = os.environ['GITHUB_TOKEN']
          url = f"https://api.github.com/repos/{repo}/actions/workflows/ingest.yml/runs?branch=main&per_page=50"
          req = urllib.request.Request(url, headers={
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github+json'
          })
          try:
              with urllib.request.urlopen(req, timeout=30) as resp:
                  data = json.load(resp)
          except Exception:
              out = os.environ.get('GITHUB_OUTPUT')
              if out:
                  with open(out, 'a') as fh:
                      fh.write('run_id=\n')
              print('Could not query workflow runs; continuing without run id')
              sys.exit(0)
          for run in data.get('workflow_runs', []):
              if run.get('conclusion') == 'success':
                  rid = run.get('id')
                  out = os.environ.get('GITHUB_OUTPUT')
                  if out:
                      with open(out, 'a') as fh:
                          fh.write(f'run_id={rid}\n')
                  print(f'Found ingest run id: {rid}')
                  sys.exit(0)
          out = os.environ.get('GITHUB_OUTPUT')
          if out:
              with open(out, 'a') as fh:
                  fh.write('run_id=\n')
          print('No successful ingest run found; continuing without run id')
          PY

      - name: Download postman_state artifact
        uses: actions/download-artifact@v4
        with:
          name: postman_state
          path: generated
          run-id: ${{ steps.find_ingest.outputs.run_id }}
          repository: ${{ github.repository }}
        continue-on-error: true

      - name: Show downloaded artifact files
        shell: bash
        run: |
          set -euo pipefail
          echo 'Generated dir contents:'
          ls -la generated || true

      - name: Run reset script
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
        shell: bash
        run: |
          set -euo pipefail
          pwd
          ls -la
          python scripts/reset_demo.py
