name: 04 - Reset Demo (Safe reset)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type RESET to confirm demo reset'
        required: true
      collection_uid:
        description: 'Postman Collection UID to delete'
        required: true

permissions:
  contents: read
  actions: read

jobs:
  reset:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate confirmation
        run: |
          if [[ "${{ github.event.inputs.confirm }}" != "RESET" ]]; then
            echo "Confirmation did not match 'RESET' - aborting"
            exit 1
          fi

      # Find the most recent successful run on main that actually uploaded an artifact named "postman_state"
      - name: Find latest run id that has postman_state artifact
        id: find_ingest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        shell: bash
        run: |
          python - << 'PY'
          import os, sys, json, urllib.request

          repo = os.environ["GITHUB_REPOSITORY"]
          token = os.environ["GITHUB_TOKEN"]
          out = os.environ.get("GITHUB_OUTPUT")

          def gh_get(url: str):
            req = urllib.request.Request(
              url,
              headers={
                "Authorization": f"token {token}",
                "Accept": "application/vnd.github+json",
                "User-Agent": "postman-reset-demo"
              }
            )
            with urllib.request.urlopen(req, timeout=30) as resp:
              return json.load(resp)

          def write_output(key: str, value: str):
            if out:
              with open(out, "a", encoding="utf-8") as fh:
                fh.write(f"{key}={value}\n")

          try:
            # Pull recent successful runs on main (across ALL workflows)
            runs_url = f"https://api.github.com/repos/{repo}/actions/runs?branch=main&per_page=60"
            runs_data = gh_get(runs_url)
          except Exception as e:
            print(f"Could not query workflow runs: {e}")
            write_output("run_id", "")
            sys.exit(0)

          runs = runs_data.get("workflow_runs", []) or []
          # Prefer most recent
          for run in runs:
            if run.get("conclusion") != "success":
              continue

            run_id = run.get("id")
            if not run_id:
              continue

            try:
              artifacts_url = f"https://api.github.com/repos/{repo}/actions/runs/{run_id}/artifacts?per_page=100"
              artifacts_data = gh_get(artifacts_url)
            except Exception:
              continue

            artifacts = artifacts_data.get("artifacts", []) or []
            for a in artifacts:
              if a.get("name") == "postman_state" and not a.get("expired", False):
                write_output("run_id", str(run_id))
                print(f"Found run id with postman_state artifact: {run_id}")
                sys.exit(0)

          print("No successful run found with a non-expired postman_state artifact; continuing without artifact")
          write_output("run_id", "")
          PY

      - name: Download postman_state artifact (best-effort)
        if: ${{ steps.find_ingest.outputs.run_id != '' }}
        uses: actions/download-artifact@v4
        with:
          name: postman_state
          path: generated
          run-id: ${{ steps.find_ingest.outputs.run_id }}
          repository: ${{ github.repository }}
        continue-on-error: true

      - name: Show downloaded artifact files
        shell: bash
        run: |
          set -euo pipefail
          echo 'Generated dir contents:'
          ls -la generated || true

      - name: Run reset script
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
          POSTMAN_COLLECTION_UID: ${{ inputs.collection_uid }}
        shell: bash
        run: |
          set -euo pipefail
          pwd
          ls -la
          python scripts/reset_demo.py
