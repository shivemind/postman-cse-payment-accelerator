name: 04 - Reset Demo (Safe reset)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type RESET to confirm demo reset"
        required: true
      collection_uid:
        description: "Postman Collection UID to delete"
        required: true

permissions:
  contents: read
  actions: read

jobs:
  reset:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate confirmation
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event.inputs.confirm }}" != "RESET" ]]; then
            echo "Confirmation did not match 'RESET' - aborting"
            exit 1
          fi

      # Find a successful ingest.yml run that actually has the postman_state artifact
      - name: Find latest ingest run id (with postman_state artifact)
        id: find_ingest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail
          python - << 'PY'
          import os, sys, json, urllib.request

          repo = os.environ['GITHUB_REPOSITORY']
          token = os.environ['GITHUB_TOKEN']

          def gh_get(url: str):
              req = urllib.request.Request(
                  url,
                  headers={
                      'Authorization': f'token {token}',
                      'Accept': 'application/vnd.github+json'
                  }
              )
              with urllib.request.urlopen(req, timeout=30) as resp:
                  return json.load(resp)

          out = os.environ.get('GITHUB_OUTPUT')

          try:
              runs = gh_get(f"https://api.github.com/repos/{repo}/actions/workflows/ingest.yml/runs?branch=main&per_page=50")
          except Exception as e:
              if out:
                  with open(out, 'a') as fh:
                      fh.write("run_id=\n")
              print(f"Could not query workflow runs: {e}")
              sys.exit(0)

          for run in runs.get('workflow_runs', []):
              if run.get('conclusion') != 'success':
                  continue

              rid = run.get('id')
              try:
                  arts = gh_get(f"https://api.github.com/repos/{repo}/actions/runs/{rid}/artifacts")
              except Exception:
                  continue

              names = [a.get('name') for a in arts.get('artifacts', [])]
              if "postman_state" in names:
                  if out:
                      with open(out, 'a') as fh:
                          fh.write(f"run_id={rid}\n")
                  print(f"Found run id with postman_state artifact: {rid}")
                  sys.exit(0)

          if out:
              with open(out, 'a') as fh:
                  fh.write("run_id=\n")
          print("No successful ingest run with postman_state artifact found")
          PY

      - name: Debug selected run id
        shell: bash
        run: |
          set -euo pipefail
          echo "Selected ingest run id: '${{ steps.find_ingest.outputs.run_id }}'"

      - name: Download postman_state artifact
        uses: actions/download-artifact@v4
        with:
          name: postman_state
          path: generated
          run-id: ${{ steps.find_ingest.outputs.run_id }}
          repository: ${{ github.repository }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Show downloaded artifact files
        shell: bash
        run: |
          set -euo pipefail
          echo "Generated dir contents:"
          ls -la generated || true

      - name: Run reset script
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
          POSTMAN_COLLECTION_UID: ${{ inputs.collection_uid }}
        shell: bash
        run: |
          set -euo pipefail
          pwd
          ls -la
          python scripts/reset_demo.py
